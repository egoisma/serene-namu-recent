<!DOCTYPE html>
<html>
    <head>
        <title>serene-namu-recent</title>
        <meta http-equiv="Content-Type" content="text/html"; charset="UTF-8">
        <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js" type="text/javascript" charset="utf-8"></script>
        <style>
            body {
                font-family:'돋움';
            }
            h1 {
                color : #00a495;
                font-size : 46px;
            }
            button {
                background: #00a495;
                color: #fff;
                border: none;
                outline: none;
                font-size: 22px;
                width: 398px;
                height: 54px;
            }
        </style>
    </head>
    <body>
        <div align=center >
            <h1>serene-namu-recent</h1>
            <h3>기동 상태 : <span id="state_getdata">On</span></h3>
            <div id="svg"></div>
            <br />
            <button onclick="start()">시작</button>
            <button onclick="stop()">중지</button>
            <br /><br />
            <br /><br />
            Copyright 2020. Kihun Jang. All rights reserved.
            <br /><br />
        </div>
        <script type="text/javascript">
            
            const paperWidth = 800;
            const paperHeight = 400;

            var paper = Raphael(document.getElementById('svg'), paperWidth, paperHeight);
            paper.rect(0, 0, paperWidth, paperHeight);

            //var audio = new Audio("./sound/waterdrop.mp3");
            //audio.volume=1;

            var timer_getData = setInterval(getData, 1000);
            
            function sleep(ms) { // 다른 곳에서 가져온 코드
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            function getData() {
                $.ajax({
                    type : 'GET',
                    url : 'http://localhost:5000/data',
                    data : {},
                    success : function(data) {
                        
                        var wiki = data["wiki"];
                        for(var i=0; i<wiki.length; i++) {
                            var fontSize = (Math.abs(wiki[i]["size"])>50 ? 50 : Math.abs(wiki[i]["size"]/4.0)+18.0);

                            var x = Math.random()*(paperWidth-fontSize*(wiki[i]["name"].length+1))+fontSize*(wiki[i]["name"].length+1)/2;
                            var y = Math.random()*(paperHeight-(fontSize+2))+(fontSize+2)/2;
                            var color = wiki[i]["size"]>=0 ? 'green' : 'red';

                            var text = paper.text(x, y, wiki[i]["name"]);
                            // var 사용하면 변수의 scope가 function 최상단이 된다는데..
                            // -> let 사용해보기(for문 바깥에서 먼저 선언ㄴ)

                            console.log("new wiki: " + wiki[i]["name"]);
                            //audio.play(); // not working

                            text.attr({
                                'fill' : color,
                                'font-size' : fontSize,
                                'font-family' : '돋움',
                                'fill-opacity' : 0.05
                            });

                            const opac_trans_speed = 0.05;

                            var incOpacity = function() {
                                text.attr({
                                'fill-opacity' : text.attr('fill-opacity') + opac_trans_speed
                                });
                            };
                            
                            var decOpacity = function() {
                                text.attr({
                                'fill-opacity' : text.attr('fill-opacity') - opac_trans_speed
                                });
                            };

                            var timer_incOpacity = setInterval(function() {
                                if(text.attr('fill-opacity')<1) incOpacity();
                                else clearInterval(timer_incOpacity);
                            }, 50);

                            setTimeout(function() {
                                var timer_decOpacity = setInterval(function() {
                                    if(text.attr('fill-opacity')>0) decOpacity();
                                    else {
                                        clearInterval(timer_decOpacity);
                                        text.remove();
                                    }
                                }, 50);
                            }, 7000);

                            sleep(300);
                        }
                    },
                    error : function() {
                        alert("Get Failed");
                        clearInterval(timer_getData);
                    }
                })
            }
            function start() {
                clearInterval(timer_getData);
                timer_getData = setInterval(getData, 1000);
                document.getElementById("state_getdata").innerHTML = "On";
            }
            function stop() {
                clearInterval(timer_getData);
                document.getElementById("state_getdata").innerHTML = "Off";
            }
            
            
        </script>
    </body>
    
</html>